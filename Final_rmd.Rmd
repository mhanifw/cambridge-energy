---
title: "Final_Rmd"
author: "Hanif Wicaksono"
date: "11/28/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(sf)
library(fs)
library(janitor)
library(tidyverse)
```

```{r who consume}

#input$energy_year

energyuse %>%
  filter(reporting_year == 2017, 
         report_type != "Child", 
         electricity_use_grid_purchase_k_wh != "NA") %>%
  group_by(property_type) %>%
  summarize(sumKwh = sum(electricity_use_grid_purchase_k_wh)) %>%
  mutate(total = sum(sumKwh)) %>%
  mutate(percentage = sumKwh / total) %>%
  ggplot(aes(x = property_type, y = sumKwh)) +
  geom_col(aes(fill = property_type))

energyuse %>%
  filter(reporting_year == 2016, 
         report_type != "Child", 
         water_use_all_water_sources_kgal != "NA"
         ) %>%
  group_by(property_type) %>%
  summarize(sumKgal = sum(water_use_all_water_sources_kgal)) %>%
  mutate(total = sum(sumKgal)) %>%
  mutate(percentage = sumKgal / total) %>%
  ggplot(aes(x = property_type, y = sumKgal)) +
  geom_col(aes(fill = property_type))
           
  
```


```{r data_prep}
energyuse <-
  read_csv(file = "raw-data/Cambridge_Building_Energy_and_Water_Use_Data_Disclosure_2016-2018.csv") %>%
  clean_names() %>%
  write_rds(path = "clean-data/energyuse.rds")

file_copy(path = "clean-data/energyuse.rds", 
          new_path = "cambridge-energy-use/shiny-data/energyuse.rds")
```

```{r data_write}

energyuse <-
  read_rds(path = "cambridge-energy-use/shiny-data/energyuse.rds")

# min_built = input$year_built[1]
# max_built = input$year_built[2]

min_built = 1700
max_built = 2016

energyuse %>%
  filter(reporting_year == 2018, report_type != "Child") %>%
  filter(year_built > min_built & year_built < max_built) %>%
  ggplot(aes(x = year_built)) +
  geom_histogram(aes(fill = property_type))
```

```{r}

#year = input$energy_year

year = 2018

energyuse %>%
  filter(reporting_year == year, report_type != "Child") %>%
  group_by(property_type) %>%
  summarize(n = n()) %>%
  arrange(desc(n))
```

```{r map_prep}

parcels_shp <- 
  st_read("raw-data/parcels/") %>%
  st_as_sf()

write_rds(parcels_shp, path = "clean-data/parcels.rds")

neighborhoods <- 
  st_read("raw-data/neighborhoods/") %>%
  st_as_sf()

write_rds(neighborhoods, path = "clean-data/neighborhoods.rds")

parcel_index <- 
  st_read("raw-data/index/") %>%
  st_as_sf()

write_rds(parcel_index, path = "clean-data/parcel_index.rds")
```

```{r map_write}

# Read data

parcels_shp <- 
  read_rds("clean-data/parcels.rds") %>%
  clean_names()

parcels_shp <- 
  parcels_shp %>%
  mutate(map_lot = ml) %>%
  select(map_lot, shape_st_ar, shape_st_le, geometry)

parcel_index <-
  parcel_index %>%
  clean_names()

```


```{r shiny_export}
file_delete(path = "cambridge-energy-use/shiny-data/")

dir_create(path = "cambridge-energy-use/shiny-data")

file_copy(path = "clean-data/neighborhoods.rds", 
          new_path = "cambridge-energy-use/shiny-data/neighborhoods.rds")

file_copy(path = "clean-data/parcels.rds", 
          new_path = "cambridge-energy-use/shiny-data/parcels.rds")

file_copy(path = "clean-data/parcel_index.rds", 
          new_path = "cambridge-energy-use/shiny-data/parcel_index.rds")
```


```{r map_viz}

ggplot() +
  # geom_sf(data = parcels_shp) +
  geom_sf(data = parcel_index)
  # geom_sf(data = neighborhoods_shp, color = "red", alpha = 0)

```


